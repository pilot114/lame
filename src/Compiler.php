<?php

class Compiler
{
	private $source;

	function __construct($source)
	{
		$this->source = $source;
	}

	private function dos_header(){
		return "
	4d5a 9000 0300 0000 0400 0000 ffff 0000
	b800 0000 0000 0000 4000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 b000 0000
	0e1f ba0e 00b4 09cd 21b8 014c cd21 5468
	6973 2070 726f 6772 616d 2063 616e 6e6f
	7420 6265 2072 756e 2069 6e20 444f 5320
	6d6f 6465 2e0d 0d0a 2400 0000 0000 0000
	f92d 72d9 bd4c 1c8a bd4c 1c8a bd4c 1c8a
	9a8a 718a bc4c 1c8a 9a8a 648a bc4c 1c8a
	5269 6368 bd4c 1c8a 0000 0000 0000 0000
		";
	}
	private function file_header(){
		return "
	5045 0000 4c01 0100 6fbd 4545 0000 0000
	0000 0000 e000 0301
		";
	}
	private function standart_fields(){
		return "
						0b01 0800 0002 0000
	0000 0000 0000 0000 0010 0000 0010 0000
	0020 0000
		";
	}
	private function windows_fields(){
		return "
		 	  0000 4000 0010 0000 0002 0000
	0400 0000 0000 0000 0400 0000 0000 0000
	0020 0000 0002 0000 0000 0000 0200 0004
	0000 1000 0010 0000 0000 1000 0010 0000
	0000 0000 1000 0000
		";
	}
	private function optional_header(){
		return $this->standart_fields() . $this->windows_fields();
	}

	private function data_directories(){
		return "
						0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000
		";
	}

	private function section_header(){
		return "
						2e74 6578 7400 0000
	0400 0000 0010 0000 0002 0000 0002 0000
	0000 0000 0000 0000 0000 0000 2000 0060
		";
	}

	private function section_body(){
		return "
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000"
	. $this->source .
			 "0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
	0000 0000 0000 0000 0000 0000 0000 0000
		";
	}

	public function createPE()
	{
		$hexString = 
		$this->dos_header() .
		$this->file_header() .
		$this->optional_header() .
		$this->data_directories() .
		// only one .text section
		$this->section_header() .
		$this->section_body();

		// remove spaces
		$hexString = preg_replace('/\s+/', '', $hexString);
		return hex2bin($hexString);
	}
}